// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  address   String   @unique
  createdAt DateTime @default(now())
  
  deposits  Deposit[]
  profits   Profit[]
  withdrawals CapitalWithdrawal[]
  affiliateRelation Affiliate? @relation("UserAffiliate")
  referredUsers     Affiliate[] @relation("ReferrerAffiliate")
  serviceDelegations ServiceDelegation[]
  withdrawalRequests WithdrawalRequest[]
  auditLogs          AuditLog[]
}

model Vault {
  id             Int      @id @default(autoincrement())
  address        String   @unique
  tokenAddress   String   // ERC-20 stablecoin contract address on Ethereum
  tokenSymbol    String   // Stablecoin symbol (e.g., USDC, USDT, DAI)
  ownerAddress   String
  ledgerAddress  String
  totalValueLocked String @default("0") // Store as string in token's smallest unit (e.g., USDC uses 6 decimals)
  createdAt      DateTime @default(now())
  isPaused       Boolean  @default(false)
  
  deposits       Deposit[]
  profits        Profit[]
  withdrawals    CapitalWithdrawal[]
  withdrawalRequests WithdrawalRequest[]
  auditLogs          AuditLog[]
}

model Deposit {
  id        Int      @id @default(autoincrement())
  userId    Int
  vaultId   Int
  amount    String   // Stablecoin amount in smallest unit (e.g., 10 USDC = 10000000 for 6 decimals)
  createdAt DateTime @default(now())
  txHash    String?  @unique
  
  user      User     @relation(fields: [userId], references: [id])
  vault     Vault    @relation(fields: [vaultId], references: [id])
}

model Profit {
  id         Int      @id @default(autoincrement())
  userId     Int
  vaultId    Int
  amount     String   // Stablecoin profit amount in smallest unit
  withdrawn  Boolean  @default(false)
  createdAt  DateTime @default(now())
  withdrawTxHash String? @unique
  
  user       User     @relation(fields: [userId], references: [id])
  vault      Vault    @relation(fields: [vaultId], references: [id])
}

model CapitalWithdrawal {
  id        Int      @id @default(autoincrement())
  userId    Int
  vaultId   Int
  amount    String   // Stablecoin amount in smallest unit
  createdAt DateTime @default(now())
  txHash    String?  @unique

  user      User     @relation(fields: [userId], references: [id])
  vault     Vault    @relation(fields: [vaultId], references: [id])
}

model Affiliate {
  id              Int      @id @default(autoincrement())
  userId          Int      @unique
  referrerId      Int
  totalEarnings   String   @default("0") // Stablecoin earnings in smallest unit
  createdAt       DateTime @default(now())
  
  user            User     @relation("UserAffiliate", fields: [userId], references: [id])
  referrer        User     @relation("ReferrerAffiliate", fields: [referrerId], references: [id])
}

model FactorySettings {
  id                 Int      @id @default(autoincrement())
  minDeposit         String   @default("10000000") // Minimum deposit in token's smallest unit (e.g., 10 USDC = 10000000 for 6 decimals)
  affiliateShareBps  Int      @default(5000) // 50%
  maxFeePercent      Int      @default(20) // 20%
  isPaused           Boolean  @default(false)
  updatedAt          DateTime @updatedAt
}

// --- Delegations & Withdrawal Requests ---

enum DelegationStatus {
  ACTIVE
  REVOKED
}

enum RequestStatus {
  PENDING
  APPROVED
  EXECUTED
  REJECTED
}

model ServiceDelegation {
  id              Int      @id @default(autoincrement())
  userId          Int
  delegatedSigner String
  policy          Json     // JSON policy: { allowlist: [vaultAddress], maxPerTx: string, dailyLimit: string, custodial: boolean }
  status          DelegationStatus @default(ACTIVE)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id])
}

model WithdrawalRequest {
  id          Int      @id @default(autoincrement())
  userId      Int
  vaultId     Int
  amount      String
  mode        String   // "auto" | "eip712"
  status      RequestStatus @default(PENDING)
  onChain     Boolean  @default(false)
  requestHash String   @unique
  signature   String?
  deadline    DateTime?
  txHash      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id])
  vault       Vault    @relation(fields: [vaultId], references: [id])
  auditLogs   AuditLog[]
}

model AuditLog {
  id         Int      @id @default(autoincrement())
  action     String
  userId     Int?
  vaultId    Int?
  requestId  Int?
  status     String
  details    Json
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  user       User?    @relation(fields: [userId], references: [id])
  vault      Vault?   @relation(fields: [vaultId], references: [id])
  request    WithdrawalRequest? @relation(fields: [requestId], references: [id])
}
