<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts\TrudeFactory.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> TrudeFactory.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">40.63% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>13/32</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">9.26% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>5/54</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">14.29% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>2/14</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">40.91% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>18/44</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.25;
&nbsp;
/**
 * @title TRUDE Factory
 * @notice Deploys new vaults, manages affiliate registry and global parameters.
 * @author TRUDE
 * @dev UUPS Upgradeable, Pausable, Ownable (Ledger multisig compatible)
 */
&nbsp;
import { Initializable } from "@openzeppelin/contracts-upgradeable/proxy/utils/Initializable.sol";
import { OwnableUpgradeable } from "@openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol";
import { PausableUpgradeable } from "@openzeppelin/contracts-upgradeable/security/PausableUpgradeable.sol";
import { UUPSUpgradeable } from "@openzeppelin/contracts-upgradeable/proxy/utils/UUPSUpgradeable.sol";
&nbsp;
import "./TrudeVault.sol";
import "./TrudeAffiliate.sol";
&nbsp;
// Minimal interface for the affiliate tracker to avoid symbol resolution issues
interface ITrudeAffiliate {
    function recordAffiliateEarning(address affiliate, uint256 amount) external;
}
&nbsp;
contract TrudeFactory is
    Initializable,
    OwnableUpgradeable,
    PausableUpgradeable,
    UUPSUpgradeable
{
    /// @notice Ledger multisig for secondary authorization
    address public ledger;
    /// @notice Optional affiliate tracker contract (owned by protocol)
    address public affiliateTracker;
&nbsp;
    /// @notice Minimum deposit (configurable)
    uint256 public minDeposit;
    /// @notice Affiliate fee share in basis points (e.g., 5000 = 50%)
    uint256 public affiliateShareBps;
    /// @notice Maximum dynamic fee percent cap
    uint256 public maxFeePercent;
&nbsp;
    /// @notice Mapping user → affiliate
    mapping(address =&gt; address) public affiliateOf;
    /// @notice Authorized vaults created by this factory
    mapping(address =&gt; bool) public isVault;
&nbsp;
    /// @notice Event emitted when vault is created
    /**
     * @notice Emitted when a new vault is created
     * @param vault The created vault address
     * @param creator The address that requested creation
     */
    event VaultCreated(address indexed vault, address indexed creator);
&nbsp;
    /**
     * @notice Emitted when a user is registered with an affiliate
     * @param user The registered user
     * @param referrer The affiliate/referrer address
     */
    event AffiliateRegistered(address indexed user, address indexed referrer);
&nbsp;
    /**
     * @notice Emitted when the ledger address is updated
     * @param newLedger The new ledger address
     */
    event LedgerUpdated(address newLedger);
&nbsp;
    /**
     * @notice Emitted when minimum deposit is updated
     * @param newMin The new minimum deposit amount
     */
    event MinDepositUpdated(uint256 newMin);
&nbsp;
    /**
     * @notice Emitted when affiliate share basis points are updated
     * @param newShareBps The new affiliate share in bps
     */
    event AffiliateShareUpdated(uint256 newShareBps);
&nbsp;
    /**
     * @notice Emitted when max fee percent is updated
     * @param newMax The new max fee percent
     */
    event MaxFeeUpdated(uint256 newMax);
&nbsp;
<span class="fstat-no" title="function not covered" >    modifier onlyLedger() {</span>
<span class="cstat-no" title="statement not covered" >        if (msg.sender != ledger) revert NotAuthorized();</span>
        _;
    }
&nbsp;
    /// @notice Initializer (replaces constructor)
    function initialize(address _owner, address _ledger, uint256 _minDeposit)
        public
        <span class="missing-if-branch" title="else path not taken" >E</span>initializer
    {
        __Ownable_init();
        transferOwnership(_owner);
        __Pausable_init();
        __UUPSUpgradeable_init();
&nbsp;
        <span class="missing-if-branch" title="if path not taken" >I</span>if (_ledger == address(0)) revert ZeroLedger();
        <span class="missing-if-branch" title="if path not taken" >I</span>if (_owner == address(0)) revert ZeroOwner();
&nbsp;
        ledger = _ledger;
        minDeposit = _minDeposit;
        affiliateShareBps = 5000; // 50%
        maxFeePercent = 20; // 20%
    }
&nbsp;
    /// @notice Authorize UUPS upgrades
<span class="fstat-no" title="function not covered" >    function _authorizeUpgrade(address) internal override onlyOwner {}</span>
&nbsp;
    // --- Factory Core ---
&nbsp;
    function createVault(address _token) external <span class="missing-if-branch" title="else path not taken" >E</span>whenNotPaused returns (address) {
        <span class="missing-if-branch" title="if path not taken" >I</span>if (_token == address(0)) revert ZeroToken();
        TrudeVault vault = new TrudeVault();
        address own = owner();
        address led = ledger;
        vault.initialize(address(this), _token, own, led);
        isVault[address(vault)] = true;
        emit VaultCreated(address(vault), msg.sender);
        return address(vault);
    }
&nbsp;
    // --- Affiliate registry ---
&nbsp;
<span class="fstat-no" title="function not covered" >    function registerAffiliate(address user, address referrer) external whenNotPaused {</span>
<span class="cstat-no" title="statement not covered" >        if (user == address(0) || referrer == address(0)) revert ZeroAddress();</span>
<span class="cstat-no" title="statement not covered" >        if (affiliateOf[user] != address(0)) revert AlreadyRegistered();</span>
        affiliateOf[user] = referrer;
<span class="cstat-no" title="statement not covered" >        emit AffiliateRegistered(user, referrer);</span>
    }
&nbsp;
    // --- Admin functions ---
&nbsp;
<span class="fstat-no" title="function not covered" >    function setLedger(address _newLedger) external onlyOwner {</span>
<span class="cstat-no" title="statement not covered" >        if (_newLedger == address(0)) revert ZeroAddress();</span>
        ledger = _newLedger;
<span class="cstat-no" title="statement not covered" >        emit LedgerUpdated(_newLedger);</span>
    }
&nbsp;
    /// @notice Set affiliate tracker contract address
<span class="fstat-no" title="function not covered" >    function setAffiliateTracker(address _tracker) external onlyOwner {</span>
<span class="cstat-no" title="statement not covered" >        if (_tracker == address(0)) revert ZeroAddress();</span>
        affiliateTracker = _tracker;
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function setMinDeposit(uint256 _newMin) external onlyOwner {</span>
        minDeposit = _newMin;
<span class="cstat-no" title="statement not covered" >        emit MinDepositUpdated(_newMin);</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function setAffiliateShareBps(uint256 _newShareBps) external onlyOwner {</span>
<span class="cstat-no" title="statement not covered" >        if (_newShareBps &gt; 10000) revert InvalidBps();</span>
        affiliateShareBps = _newShareBps;
<span class="cstat-no" title="statement not covered" >        emit AffiliateShareUpdated(_newShareBps);</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function setMaxFeePercent(uint256 _newMax) external onlyOwner {</span>
<span class="cstat-no" title="statement not covered" >        if (_newMax &gt; 100) revert InvalidPercent();</span>
        maxFeePercent = _newMax;
<span class="cstat-no" title="statement not covered" >        emit MaxFeeUpdated(_newMax);</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function pause() external onlyLedger {</span>
<span class="cstat-no" title="statement not covered" >        _pause()</span>;
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function unpause() external onlyLedger {</span>
<span class="cstat-no" title="statement not covered" >        _unpause()</span>;
    }
&nbsp;
    /// @notice Record affiliate earning via tracker (callable only by authorized vaults)
<span class="fstat-no" title="function not covered" >    function recordAffiliateEarning(address affiliate, uint256 amount) external {</span>
<span class="cstat-no" title="statement not covered" >        if (!isVault[msg.sender]) revert NotVault();</span>
<span class="cstat-no" title="statement not covered" >        if (affiliateTracker != address(0)) {</span>
<span class="cstat-no" title="statement not covered" >            ITrudeAffiliate(affiliateTracker).recordAffiliateEarning(affiliate, amount)</span>;
        }
    }
&nbsp;
    /// @notice Forward profit registration to a specific vault (owner-controlled)
    /// @dev Satisfies Vault's onlyFactory modifier by invoking as Factory
<span class="fstat-no" title="function not covered" >    function registerProfitFor(address vault, address user, uint256 profit)</span>
        external
        onlyOwner
        whenNotPaused
    {
<span class="cstat-no" title="statement not covered" >        if (!isVault[vault]) revert NotVault();</span>
<span class="cstat-no" title="statement not covered" >        TrudeVault(vault).registerProfit(user, profit)</span>;
    }
&nbsp;
    // --- Custom errors ---
    error NotAuthorized();
    error ZeroLedger();
    error ZeroOwner();
    error ZeroToken();
    error ZeroAddress();
    error AlreadyRegistered();
    error InvalidBps();
    error InvalidPercent();
    error NotVault();
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Sat Nov 08 2025 12:30:42 GMT+0100 (Ora standard dell’Europa centrale)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
